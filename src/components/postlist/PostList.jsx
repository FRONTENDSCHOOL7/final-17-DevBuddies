import React from "react";
import more from "../../assets/images/s-icon-more-vertical.png";
import message from "../../assets/images/icon-message-circle.png";
import { useState } from "react";
import { useEffect } from "react";
import { postUserApi } from "../../api/PostApi";
import { useRecoilValue } from "recoil";
import { useInView } from "react-intersection-observer";
import { Sect3 } from "./PostListStyle";
import { profileImgState, tokenState } from "../../state/AuthAtom";
import { accountNameState } from "../../state/AuthAtom";
import { ReactComponent as Like } from "../../assets/images/icon-heart.svg";

export default function PostList() {
  const accountName = useRecoilValue(accountNameState);
  const [postData, setPostData] = useState([]);
  const [skip, setSkip] = useState(0);
  const [ref, inView] = useInView();
  const image = useRecoilValue(profileImgState);
  const token = useRecoilValue(tokenState);
  const [heart, setHeart] = useState("false");

  // Ï¢ãÏïÑÏöî Î≤ÑÌäº
  const handleLike = (postId) => {
    // Í≤åÏãúÎ¨º IDÎ•º Ïù¥Ïö©ÌïòÏó¨ Ìï¥Îãπ Í≤åÏãúÎ¨ºÏùò Ïù∏Îç±Ïä§Î•º Ï∞æÏùå
    const postIndex = postData.findIndex((item) => item.id === postId);

    if (postIndex !== -1) {
      // Î≥µÏÇ¨Î≥∏ÏùÑ ÎßåÎì§Ïñ¥ Ìï¥Îãπ Í≤åÏãúÎ¨ºÏùò `hearted` Í∞íÏùÑ ÌÜ†Í∏Ä
      const updatedPostData = [...postData];
      updatedPostData[postIndex].hearted = !updatedPostData[postIndex].hearted;

      // ÏóÖÎç∞Ïù¥Ìä∏Îêú Îç∞Ïù¥ÌÑ∞Î•º ÏÉÅÌÉúÏóê ÏÑ§Ï†ï
      setPostData(updatedPostData);

      localStorage.setItem(
        `likeStatus_${postId}`,
        updatedPostData[postIndex].hearted
      );
    }
  };

  // ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò Ìï®Ïàò
  const getDate = (date) => {
    const _date = new Date(date);
    const yyyy = _date.getFullYear();
    const mm = _date.getMonth() + 1;
    const dd = _date.getDate();
    const hours = _date.getHours();
    const minutes = _date.getMinutes();
    return `${yyyy}.${mm}.${dd}. ${hours.toString().padStart(2, "0")}:${minutes
      .toString()
      .padStart(2, "0")}`;
  };

  // Ïú†Ï†Ä Í≤åÏãúÍ∏Ä Î™©Î°ù api ÏöîÏ≤≠
  const postFetch = async () => {
    try {
      console.log("ÌÜ†ÌÅ∞", token);
      console.log("Ïñ¥Ïπ¥Ïö¥Ìä∏ÎÑ§ÏûÑ", accountName);
      const result = await postUserApi(accountName, token, skip);

      console.log("@@@");
      console.log(result.post);
      console.log(postData);

      setPostData((postData) => {
        return [...postData, ...result.post];
      });
      setSkip((skip) => skip + 20);
    } catch (error) {
      console.log("Ïã§Ìå®ÌñàÏäµÎãàÎã§");
    }
  };
  useEffect(() => {
    postData.forEach((item) => {
      const likeStatus = localStorage.getItem(`likeStatus_${item.id}`);
      if (likeStatus !== null) {
        item.hearted = likeStatus === "true";
      }
    });
    setPostData(postData);
  }, []);
  // iinView && !isendÍ∞Ä true Ïùº ÎïåÎßå Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¥!
  // ÌéòÏù¥ÏßÄ ÏãúÏûë Ïãú Î†åÎçîÎßÅ
  useEffect(() => {
    if (inView) {
      console.log(inView, "Î¨¥Ìïú Ïä§ÌÅ¨Î°§ ÏöîÏ≤≠ üéÉ");
      postFetch();
    }
  }, [inView]);

  return (
    <Sect3>
      <div>
        {postData?.map((item, idx) => {
          return (
            <div className='content-container' key={idx}>
              <div className='content-list'>
                <img src={image} alt='' className='profile-img' />
                <div className='content'>
                  <div className='content-title'>
                    <div className='content-id'>
                      <h3>{item.author.accountname}</h3>
                      <p>{item.author.username}</p>
                    </div>
                    <div>
                      <button>
                        <img src={more} alt='' />
                      </button>
                    </div>
                  </div>
                  <div className='content-inner'>
                    <p>{item.content}</p>
                    <img src={item.image} alt='' />
                  </div>
                  <div className='like-comment'>
                    <button onClick={() => handleLike(item.id)}>
                      <Like fill={item.hearted ? "#12184E" : "#fff"}></Like>
                      <span>12</span>
                    </button>
                    <button>
                      <img src={message} alt='' /> <span>12</span>
                    </button>
                  </div>
                  <span className='date'>{getDate(item.updatedAt)}</span>
                </div>
              </div>
            </div>
          );
        })}
      </div>
      <div ref={ref}>.</div>
    </Sect3>
  );
}
